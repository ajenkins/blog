<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png" />
    <link rel="manifest" href="/static/site.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dating App: Progress Update 1</title>
    <meta name="description" content="" />
    
    <style>
      body{background:#fff;color:#111;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;-webkit-font-smoothing:antialiased;margin:0 auto}main{margin:1.5rem}#comments-section,#container,article{width:100%;max-width:40rem;margin:0 auto}p.subtitle{margin-top:0;margin-bottom:.5rem;font-size:1.5rem;font-weight:200}iframe,img{max-width:40rem;width:100%}h1{margin-bottom:.5rem;font-size:2rem}p{margin-top:1.5rem;margin-bottom:0;line-height:1.5rem}li{line-height:1.5rem}a{color:-webkit-link;text-decoration:none}a:hover{text-decoration:underline}a.footnote{vertical-align:super;font-size:.8em}time{font-size:.8em;color:#555}nav{display:flex;align-items:center;margin:1rem}#main-logo{width:8rem;margin:0 1rem}#github-mark{width:3rem;margin:0 1rem}#about-link{margin:0 1rem;font-size:2rem}.comment-entry{margin-top:1.5rem;border:1px solid #ccc;border-radius:16px;padding:1rem}.comment-author,.comment-body,.comment-submitted-at{margin:.5rem 0}#comment-form>div{margin-bottom:1rem}label{display:block;margin-bottom:.5rem;font-weight:600}#comment-body-input{box-sizing:border-box;width:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;-webkit-font-smoothing:antialiased}#required-control{display:none}.publication-date{color:#555}#about-photo{width:20rem;margin:auto;display:block;border-radius:50%}div.email-signup-form{border:1px solid #888;border-radius:.5rem;margin:3rem 0;padding:1.5rem;box-shadow:1px 1px 2px #aaa}div.email-signup-form>p{font-size:.9rem;font-weight:600;margin:0}div.email-signup-form>form{display:flex;margin-top:1rem}div.email-signup-form>form>input[type=email]{flex-grow:1;font-size:1rem;margin-right:.5rem}div.email-signup-form>form>input[type=submit]{background-color:#ff8000;border:none;border-radius:.2rem;font-size:1rem;padding:.5rem;-webkit-appearance:none}.redacted{color:#000;background-color:#000}.redacted::selection{background-color:#000}
    </style>
    <link
      rel="preload"
      href="/static/prism.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    >
  </head>
  <body>
    <nav>
      <a href="/"><img id="main-logo" src="/static/aj_logo.svg" alt="AJ" /></a>
      <a href="https://github.com/ajenkins/blog">
        <img id="github-mark" src="/static/GitHub-Mark.png" alt="Link to GitHub repo">
      </a>
      <a href="/about" id="about-link">
        About
      </a>
    </nav>
    <main>
      
<article>
  <header>
    <h1>Dating App: Progress Update 1</h1>
    
    <time datetime="2020-12-27T14:00:00.000Z">
      December 27, 2020
    </time>
  </header>
  <p>In <a href="/post/backend_for_dating_app">my last post</a>
I talked about some of the technologies that I was planning
on using for building
<a href="/post/making_a_dating_app">my dating app</a>.
Since then, I've completed the minimum functionality for the app
and wanted to share what I've done so far.</p>
<h2>On the backend</h2>
<p><em>Skip to the next section if you just want to see some screenshots.</em></p>
<p>Behind the scenes, I've set up an Aurora (Postgres)
database running on Amazon RDS. On top of that, I'm using Hasura Cloud
to serve a GraphQL API. So far, I'm loving Hasura. Everything just works,
I haven't run into any roadblocks yet, the documentation is great, and I've
been able to fully set up my API and manage my database using their UI.
The only hiccup I've run in to with Hasura was in the initial set up.
They have a guide specifically on how to set up Hasura with Aurora, but
the guide doesn't mention that it doesn't work with the serverless option and
you need to set up your database as provisioned. I had to contact support, but
they figured it out pretty quickly and I just had to create a new database.</p>
<p>For user authentication I'm using AWS Cognito and Amplify. This might
be surprising to you if you read <a href="/post/review_of_appsync_and_amplify">my review of Amplify</a>,
but it seems like it's evolved a lot since I last used it. Using Amplify also seemed like
the easiest way to integrate Cognito into a React Native app. The even have specific
instructions on how to use Amplfiy with an app managed with Expo, which I was using
in the beginning until I had to eject (more on ejecting later).
Also, you can now
use Amplify just for one function, like auth, and you don't need to use Amplify
for your API if you don't want to.<a href="#footnote-1" class="footnote">[1]</a>
I go into more detail about my experience using Amplify at the end of this post.</p>
<h2>The frontend</h2>
<p>Once I got the backend working, the next step was to build the mobile app
itself which would talk to the backend. I decided to use React Native to
build my app because I have a lot of experience with React and I didn't
want to have to write my app twice, once in Swift for iOS and once in
Java/Kotlin for Android.</p>
<p>I also wanted to use <a href="https://expo.io">Expo</a>,
because I had a great experience using it with my last React Native
project. It's pretty magical to have hot-reloading on an app running on
my actual iPhone and not needing to use XCode or the iOS Simulator ✨</p>
<p>I recently needed to eject my Expo app from the managed workflow
to the bare workflow, which was an educational experience. You can
read about my experience ejecting at the end of this post.</p>
<h2>The app</h2>
<p>
    <img src="/static/b87c7d1e-640.png" width="640" alt="Sign-up/Log-in screen">
    <em>The first screen you'll see when you open the app.</em>
</p>
<p>
    <img src="/static/a2e9e557-640.png" width="640" alt="Log-in screen">
    <em>You sign in using a phone number and password. No email required.</em>
</p>
<p>
    <img src="/static/fd21ebd4-640.png" width="640" alt="Profile screen">
    <em>On this tab, you can see your profile information. There's no way to edit it yet.</em>
</p>
<p>
    <img src="/static/fcb4e0e6-640.png" width="640" alt="Online users screen">
    <em>
        Here you can see all of the currently online users (including yourself).
        This is real and dynamically updates.
    </em>
</p>
<p>I have the minimum functionality working now. You'll notice
that the app looks... rough. That's intentional. My strategy
when working on a software engineering project is to do the hardest thing first.
In this case, the part of the app I was most worried about was the live video-calling.
The reason you should always do the hardest part first is because there's a chance
that you might not be able to even to build it at all. Live video-calling is the
central feature of my app, and if I can't figure out how to make that work and make it
work well, then the whole app is dead on arrival. Imagine if I had spent months
implementing every other feature of the app (photos, messaging, etc.), only to discover
that I can't get the video part working and I would need to give up or make a significant pivot.
All of that time and effort would've been wasted.</p>
<h2>Next up</h2>
<h2>Bonus 1: Mini-review of Amplify in 2020</h2>
<p>My updated perspective on Amplify is that it's gotten much better since 2019,
but still feels like a beta product. I got stuck almost immediately
because when you do the initial setup of your local environment you
need to authenticate your app using a browser. I use Safari for all
of my personal work, but apparently the authentication only works with Chrome and Firefox.
If this was communicated in an error message, it wouldn't have been a problem but I had to
dig through the Github issues to figure out why the authentication wasn't working.
They also misspelled &quot;communicate&quot; with two &quot;n&quot;s in their unhelpful error message
(<a href="https://github.com/aws-amplify/amplify-adminui/issues/14">see Github issue</a>).</p>
<p>I also ran into an issue using Cognito that was significantly more challenging
to resolve because I was using Amplify. When you set up auth through Amplify,
it automatically generates two app clients, one with a secret key and one
without. I didn't originally understand the difference between these two app clients,
so I mistakenly deleted one of them. Cognito warns you that this action is irreversible,
but I thought I knew what I was doing (I didn't). Once I realized my mistake, I decided
that the simplest way to fix it would just be to start over. So I tried to delete the
Cognito stuff through the Amplify web console, but the delete failed without any
explanation. Eventually I realized the delete was failing because I first had to
manually delete the domain I created in Cognito. I then manually deleted the CloudFormation
stack created by Amplify, thinking I was making Amplify's job easier (I wasn't).
If you're using Amplify <strong>don't try to manually delete something yourself</strong>. Always
let Amplify delete its own resources. If you don't, you'll get stuck in a Catch-22
situation where it will become impossible to use your Amplify app.</p>
<p>After I deleted the CloudFormation stack, I noticed that Amplify was still showing
that I had auth setup. Amplify must have its own state about your setup, so I figured
that when I hit Delete it would just notice that the CloudFormation stack had already been
deleted and it would just update its own state to reflect that auth had been removed.</p>
<p>Instead, when I tried to remove auth through Amplify, it complained that it couldn't
find the stack to delete, so the operation failed. And if you try to add auth to the
app it complains that you already have auth, so that fails too. And when I tried
just deleting the whole Amplify app, that failed too because it tries to delete
all of the sub-components, like the auth stuff, before deleting the top-level app.
Basically, it can't delete the auth component because the auth component has already
been deleted and it can't delete the app because it can't delete the auth component 🤦‍♂️</p>
<p>Eventually, I figured out that I could trick Amplify by creating a new CloudFormation
stack with the exact name that it was looking for when it tried to delete the auth
stack. I just made a minimal stack that created a random S3 bucket, but because
the name matched the name it was expecting to exist, it happily carried out the delete
operation and let me fully delete my Amplify app. I <em>could've</em> just abandoned my broken
Amplify app and created a new one, but then I would've needed to create a new app with
a new name and I know that I would constantly mix up the two apps every time I tried
to use Amplify.</p>
<p>In conclusion, Amplify is still bad, but if you want to use Cognito or AppSync
with a web or native app, you're still better off using Amplify than trying
to implement everything yourself from scratch.</p>
<p>Also, if you're using Amplify Auth with React or React Native, I highly
recommend reading
<a href="https://www.rockyourcode.com/custom-react-hook-use-aws-amplify-auth/">this blog post by Sophia Brandt</a>.
She wrote a really good React Hook for updating your app state based on whether or not
you're logged in. This is definitely something you wouldn't want to implement yourself,
and should really be included in the core Amplify React library.</p>
<h2>Bonus 2: Ejecting Expo</h2>
<p>Expo offers two workflows: managed and bare. With the managed workflow,
you can develop your app entirely with Javascript/Typescript and can
mostly ignore platform-specific concerns with iOS and Android. This
is the recommended workflow for most use-cases, but the drawback is
that some React Native libraries either don't support it or don't
document how to use it with Expo. The other limitation is
that certain native APIs, like Bluetooth and WebRTC, are not supported
in the managed workflow. If you start off using the managed workflow
but realize later that you need to use the bare workflow (like me),
then you'll need to <a href="https://docs.expo.io/bare/customizing/">&quot;eject&quot;</a>
your app to convert your app over to the bare workflow.</p>
<p>If you're starting a new project with Expo, I highly recommend
reviewing <a href="https://docs.expo.io/introduction/why-not-expo/">the limitations of the managed workflow</a>
and deciding upfront which workflow you want to use, rather than ejecting later.
Unfortunately, the ejection process isn't as smooth as I'd hoped and I ended up needing
to spend a few days of debugging to get the app up and running again. I assume things
would've worked much better if I had started off with the bare workflow rather than
ejecting to it later.</p>
<p>That being said, <em>most</em> apps should be fine using the managed workflow.
And if you can use the managed workflow, I highly recommend it over the bare workflow.
The only reason I had to eject for this app is because I need live video calling,
which means that I need to use WebRTC which is not supported in the managed workflow.</p>
<p>If you're wondering about the bugs I encountered when I ejected, I eventually determined
that the source of all of my bugs was something called <a href="https://fbflipper.com">Flipper</a>,
which is a plugin for debugging mobile apps. I think I was having the same problem
as <a href="https://github.com/facebook/react-native/issues/29133">this person</a>,
but they closed their own issue because it magically
disappeared on its own. Unfortunately, <em>my</em> issue did <em>not</em> resolve itself,
and none of the solutions I found online fixed it. Eventually, I was able to fix
the problem by just deleting all of the Flipper-related code from <code>AppDelegate.m</code>.
I guess that means I won't be able to use Flipper in my app, but at least my app builds again.</p>
<p>I also had to install a few extra things to get Amplify Auth working again. That was pretty
easy though because it was obvious what I needed to do from
<a href="https://docs.amplify.aws/lib/auth/getting-started/q/platform/js">the Amplify docs</a>.
If you compare the instructions for Expo and React Native, you'll notice that the
React Native instructions includes an additional dependency to install,
<code>amazon-cognito-identity-js</code>, and an additional step of running <code>npx pod install</code>
afterwards. After I did that, everything in my app started working again.</p>
<p>However, I do still have one outstanding bug I haven't been able to fix, but I'll
probably just live with it. When I try to run my app directly on my iPhone using
the Expo server, the login step fails with the error
<code>getRandomBase.default is not a function</code>. I figured out that this is coming from the
<code>react-native-get-random-values</code> package, which is a dependency of <code>aws-amplify</code>.
The only solutions I could find online to this problem are uninstalling and reinstalling
<code>aws-amplify</code> or <code>react-native-get-random-values</code> or deleting my <code>node_modules/</code> directory
and re-running <code>npm install</code>. None of that fixed the problem, of course. This
also happens to be one of those fun bugs that disappears when you run the app in debug-mode 🥲</p>
<p>The silver-lining is that this issue only manifests when I run the app using Expo, not
when I run it with the iOS simulator, which implies to me that it's not a &quot;real&quot; bug
and would never be encountered by a real user. There's also a pretty simple workaround:
run the app in debug mode, log in, then disable debug mode. Once you're logged in, you
stay logged in, so it's not like I need to do this every time I run the app. That being
said, I don't think I would've hit this issue if I had started off using the bare Expo
workflow, so this is yet another reason to avoid ejecting if you can.</p>
<hr>
<p id="footnote-1">
[1]: Maybe it was always possible to use Amplify just for auth,
     but at the very least, they've definitely made this much clearer in the UI now.
</p>

</article>

<section id="comments-section">
<h1>Comments ✍️</h1>


  <p>No comments yet. Be the first!</p>


<h2>Leave a comment</h2>
<form id="comment-form" name="comment-form" method="POST" action="https://aj-blog-comments.herokuapp.com/v2/entry/ajenkins/blog/master/comments">
  <input name="options[redirect]" type="hidden" value="https://ajenkins.me/post/dating_app_update_1/">
  <input name="options[slug]" type="hidden" value="dating_app_update_1">

  <div id="required-control">
    <label>Required
      <input type="text" name="fields[required]" tabindex="-1" autocomplete="off">
    </label>
  </div>

  <div id="name-control">
    <label>Name
      <input type="text" name="fields[name]" placeholder="Anonymous" maxlength="1000" size="32">
    </label>
  </div>

  <div id="body-control">
    <label>Comment
      <textarea id="comment-body-input" name="fields[body]" required maxlength="10000" rows="10"></textarea>
    </label>
  </div>

  <div id="submit-button-control">
    <input type="submit" value="Submit">
    <em>Your comment will appear a few minutes after it's been submitted.</em>
  </div>
</form>
</section>

<p><a href="/">More posts</a></p>
    </main>
  </body>
</html>
